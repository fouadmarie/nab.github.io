<!DOCTYPE html>
<html>
<head>
    <title>Clash Web - Final Fix</title>
    <style>
        body { font-family: 'Arial Black', sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        #setup { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(#444, #111); }
        #game-ui { display: none; background: #1a1a1a; height: 100vh; width: 100vw; position: relative; }
        #arena { width: 350px; height: 480px; background: #4e7d34; margin: 5px auto; position: relative; border: 4px solid #fff; border-radius: 10px; overflow: hidden; }
        
        .tower { position: absolute; width: 44px; height: 44px; border: 3px solid #000; border-radius: 8px; z-index: 5; font-size: 11px; display: flex; align-items: center; justify-content: center; color: white; }
        .king { width: 56px; height: 56px; }
        
        .unit { width: 26px; height: 26px; position: absolute; border-radius: 50%; z-index: 10; border: 2px solid white; font-size: 10px; font-weight: bold; line-height: 26px; pointer-events: none; text-align: center; color: white; }
        .hp-bar { position: absolute; top: -10px; left: 0; width: 100%; height: 5px; background: #333; border: 1px solid white; }
        .hp-fill { height: 100%; background: #2ecc71; width: 100%; }
        
        #ui-bar { width: 350px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding: 10px; background: #222; }
        .stats-row { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        #elixir-container { width: 180px; height: 15px; background: #333; border: 2px solid white; border-radius: 10px; overflow: hidden; }
        #elixir-fill { height: 100%; background: #9b59b6; width: 0%; transition: width 0.2s linear; }
        
        /* FIXED HAND VISIBILITY */
        .hand { 
            display: flex; justify-content: center; gap: 10px; padding: 10px; 
            background: #222; position: fixed; bottom: 0; width: 100%; 
            height: 80px; z-index: 999; border-top: 4px solid #444;
        }
        .card { 
            width: 60px; height: 60px; background: #ecf0f1; border: 3px solid #3498db; 
            border-radius: 8px; cursor: grab; display: flex; flex-direction: column; 
            justify-content: center; font-size: 9px; color: #2c3e50; font-weight: bold;
        }
        .card:active { transform: scale(1.1); background: #f1c40f; }
    </style>
</head>
<body>

    <div id="setup">
        <h1 style="color: #f1c40f;">CLASH WEB</h1>
        <input type="text" id="nameInput" placeholder="NICKNAME" style="padding: 15px; width: 200px; border-radius: 5px;">
        <button onclick="findMatch()" id="startBtn" style="padding: 15px 40px; margin-top: 20px; background: #27ae60; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 5px;">BATTLE</button>
        <p id="status">Ready...</p>
    </div>

    <div id="game-ui">
        <div id="ui-bar">
            <div class="stats-row">
                <div id="timer" style="color:#f1c40f">01:00</div>
                <div id="elixir-container"><div id="elixir-fill"></div></div>
                <b id="elixir-num" style="color:#d0f;">5</b>
            </div>
        </div>
        <div id="arena" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div id="eKing" class="tower king" style="top: 10px; left: 147px; background: #c0392b;">4000</div>
            <div id="eL" class="tower" style="top: 75px; left: 45px; background: #c0392b;">2500</div>
            <div id="eR" class="tower" style="top: 75px; left: 260px; background: #c0392b;">2500</div>
            <div id="mKing" class="tower king" style="bottom: 10px; left: 147px; background: #2980b9;">4000</div>
            <div id="mL" class="tower" style="bottom: 75px; left: 45px; background: #2980b9;">2500</div>
            <div id="mR" class="tower" style="bottom: 75px; left: 260px; background: #2980b9;">2500</div>
        </div>
        <div class="hand">
            <div class="card" draggable="true" ondragstart="drag(event, 'knight', 3)">KNIGHT(3)</div>
            <div class="card" draggable="true" ondragstart="drag(event, 'giant', 5)">GIANT(5)</div>
            <div class="card" draggable="true" ondragstart="drag(event, 'archers', 3)">ARCHER(3)</div>
            <div class="card" draggable="true" ondragstart="drag(event, 'musketeer', 4)">MUSKET(4)</div>
            <div class="card" draggable="true" ondragstart="drag(event, 'skeles', 1)">SKELE(1)</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, update, push, onValue, onChildAdded, remove, get, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJGeR1gfk3l_0g4Fjeyu2RzhUdP94U1yM",
            authDomain: "clash-royale-3bd59.firebaseapp.com",
            projectId: "clash-royale-3bd59",
            databaseURL: "https://clash-royale-3bd59-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myName = "", gameId = null, elixir = 5, gameActive = false, elixirMult = 1;
        let timeLeft = 60, units = [];
        let towers = { eKing: 4000, eL: 2500, eR: 2500, mKing: 4000, mL: 2500, mR: 2500 };

        window.allowDrop = (e) => e.preventDefault();
        window.drag = (e, type, cost) => { 
            e.dataTransfer.setData("type", type); 
            e.dataTransfer.setData("cost", cost); 
        };
        
        window.drop = (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData("type"), cost = parseInt(e.dataTransfer.getData("cost"));
            const rect = document.getElementById('arena').getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            
            if (elixir >= (cost - 0.2) && gameActive && y > 200) {
                elixir -= cost;
                push(ref(db, `games/${gameId}/moves`), { type, x, y, sender: myName, id: Date.now() });
            }
        };

        window.findMatch = async () => {
            myName = document.getElementById('nameInput').value.trim() || "P" + Math.floor(Math.random()*999);
            document.getElementById('status').innerText = "SEARCHING FOR REAL PLAYERS...";
            document.getElementById('startBtn').style.display = "none";

            const qRef = ref(db, 'queue');
            const snap = await get(qRef);
            let matched = false;

            if (snap.exists()) {
                const now = Date.now();
                for (let key in snap.val()) {
                    const player = snap.val()[key];
                    // ONLY match if they joined in the last 15 seconds (prevents ghost matching)
                    if (key !== myName && (now - player.time) < 15000) {
                        gameId = key + "_vs_" + myName;
                        await remove(qRef);
                        await set(ref(db, `games/${gameId}`), { p1: key, p2: myName, start: true, moves: {} });
                        start();
                        matched = true;
                        break;
                    }
                }
            }

            if (!matched) {
                await set(ref(db, 'queue/' + myName), { name: myName, time: Date.now() });
                onDisconnect(ref(db, 'queue/' + myName)).remove();
                
                // Heartbeat to stay active in queue
                const beat = setInterval(() => {
                    if(!gameId) update(ref(db, 'queue/' + myName), { time: Date.now() });
                    else clearInterval(beat);
                }, 5000);

                onValue(ref(db, 'games'), (s) => { 
                    if (!gameId && s.exists()) {
                        for (let id in s.val()) {
                            if (id.includes(myName) && s.val()[id].start) {
                                gameId = id; 
                                start(); 
                            }
                        }
                    }
                });
            }
        };

        function start() {
            gameActive = true;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';

            onValue(ref(db, `games/${gameId}/abandoned`), (s) => { if(s.exists()) location.reload(); });
            onChildAdded(ref(db, `games/${gameId}/moves`), (s) => spawn(s.val()));

            setInterval(() => {
                if (elixir < 10) elixir = Math.min(10, elixir + (0.25 * elixirMult));
                document.getElementById('elixir-fill').style.width = (elixir * 10) + '%';
                document.getElementById('elixir-num').innerText = Math.floor(elixir);
            }, 500);

            requestAnimationFrame(gameLoop);
        }

        function spawn(m) {
            const isMine = m.sender === myName;
            const stats = {
                giant: { hp: 550, speed: 0.35, char: 'G' },
                knight: { hp: 220, speed: 0.55, char: 'K' },
                archers: { hp: 90, speed: 0.7, char: 'A' },
                musketeer: { hp: 150, speed: 0.55, char: 'M' },
                skeles: { hp: 40, speed: 0.8, char: 'S' }
            }[m.type];

            const u = {
                id: m.id, x: isMine ? m.x : 350 - m.x, y: isMine ? m.y : 480 - m.y,
                hp: stats.hp, max: stats.hp, speed: stats.speed,
                team: isMine ? 'blue' : 'red', el: document.createElement('div')
            };
            u.el.className = 'unit';
            u.el.style.backgroundColor = isMine ? '#2980b9' : '#c0392b';
            u.el.innerHTML = `<div class="hp-bar"><div class="hp-fill" id="h-${u.id}"></div></div>${stats.char}`;
            document.getElementById('arena').appendChild(u.el);
            units.push(u);
        }

        function gameLoop() {
            if (!gameActive) return;
            units.forEach((u, idx) => {
                let target = null, minDist = 999;
                units.forEach(e => { if(e.team !== u.team) { let d = Math.hypot(e.x-u.x, e.y-u.y); if(d < minDist) { minDist=d; target=e; } } });
                
                if (minDist > 80) {
                    const tList = u.team === 'blue' ? ['eL', 'eR', 'eKing'] : ['mL', 'mR', 'mKing'];
                    tList.forEach(tId => {
                        if (towers[tId] > 0) {
                            const tEl = document.getElementById(tId);
                            let d = Math.hypot(tEl.offsetLeft + 22 - u.x, tEl.offsetTop + 22 - u.y);
                            if (d < minDist) { minDist = d; target = {x: tEl.offsetLeft + 22, y: tEl.offsetTop + 22, isT: true, id: tId}; }
                        }
                    });
                }

                if (minDist < 35) {
                    if (target.isT) { towers[target.id] -= 2; document.getElementById(target.id).innerText = Math.floor(towers[target.id]); }
                    else { u.hp -= 2; target.hp -= 2; document.getElementById(`h-${u.id}`).style.width = (u.hp/u.max*100)+'%'; }
                } else if (target) {
                    let angle = Math.atan2(target.y - u.y, target.x - u.x);
                    u.x += Math.cos(angle) * u.speed; u.y += Math.sin(angle) * u.speed;
                }
                u.el.style.left = (u.x - 13) + 'px'; u.el.style.top = (u.y - 13) + 'px';
                if (u.hp <= 0) { u.el.remove(); units.splice(idx, 1); }
            });
            if (towers.eKing <= 0 || towers.mKing <= 0) { alert("GAME OVER"); location.reload(); }
            else requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
