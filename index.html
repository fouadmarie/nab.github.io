<!DOCTYPE html>
<html>
<head>
    <title>Clash Web - 3 Towers</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        #setup { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #222; }
        #game-ui { display: none; }
        #arena { width: 350px; height: 550px; background: #4e7d34; margin: 10px auto; position: relative; border: 5px solid #fff; border-radius: 10px; }
        /* Bridge/Path styling */
        .lane { position: absolute; width: 60px; height: 100%; background: rgba(0,0,0,0.1); z-index: 1; }
        
        .tower { position: absolute; width: 40px; height: 40px; border: 2px solid #000; border-radius: 5px; z-index: 5; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; color: white; }
        .king { width: 50px; height: 50px; border-radius: 8px; }
        
        .unit { width: 24px; height: 24px; position: absolute; border-radius: 50%; z-index: 10; border: 2px solid white; font-size: 10px; line-height: 24px; }
        
        #ui-bar { width: 350px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #333; }
        #elixir-container { width: 200px; height: 15px; background: #444; border: 2px solid #fff; border-radius: 10px; overflow: hidden; }
        #elixir-fill { height: 100%; background: #d0f; width: 0%; transition: width 0.2s linear; }
        .hand { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #222; }
        .card { width: 80px; height: 60px; background: #444; border: 2px solid white; cursor: grab; font-weight: bold; font-size: 12px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="setup">
        <h1>CLASH WEB 3.0</h1>
        <input type="text" id="nameInput" placeholder="Name" style="padding: 10px; font-size: 18px;">
        <button onclick="findMatch()" style="padding: 15px 30px; margin-top: 10px; background: gold; border: none; font-weight: bold; cursor: pointer;">BATTLE</button>
        <p id="status">Waiting for players...</p>
    </div>

    <div id="game-ui">
        <div id="ui-bar">
            <div id="elixir-text" style="color:#d0f; font-weight:bold; font-size: 20px;">5</div>
            <div id="elixir-container"><div id="elixir-fill"></div></div>
            <div style="font-size: 12px;">ELIXIR</div>
        </div>
        <div id="arena" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div id="eKing" class="tower king" style="top: 10px; left: 150px; background: #c03;">100</div>
            <div id="eL" class="tower" style="top: 60px; left: 50px; background: #c03;">60</div>
            <div id="eR" class="tower" style="top: 60px; left: 260px; background: #c03;">60</div>

            <div id="mKing" class="tower king" style="bottom: 10px; left: 150px; background: #05c;">100</div>
            <div id="mL" class="tower" style="bottom: 60px; left: 50px; background: #05c;">60</div>
            <div id="mR" class="tower" style="bottom: 60px; left: 260px; background: #05c;">60</div>
        </div>
        <div class="hand">
            <div class="card" draggable="true" ondragstart="drag(event, 'knight', 3)">Knight (3)</div>
            <div class="card" draggable="true" ondragstart="drag(event, 'giant', 5)">Giant (5)</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, update, push, onValue, onChildAdded, remove, get, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJGeR1gfk3l_0g4Fjeyu2RzhUdP94U1yM",
            authDomain: "clash-royale-3bd59.firebaseapp.com",
            projectId: "clash-royale-3bd59",
            storageBucket: "clash-royale-3bd59.firebasestorage.app",
            messagingSenderId: "919817270159",
            appId: "1:919817270159:web:074acb7f1e7264917791fa",
            databaseURL: "https://clash-royale-3bd59-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myName = "", gameId = null, elixir = 5, gameActive = false;
        let units = [];
        let towers = {
            eKing: 100, eL: 60, eR: 60,
            mKing: 100, mL: 60, mR: 60
        };

        window.allowDrop = (e) => e.preventDefault();
        window.drag = (e, type, cost) => { e.dataTransfer.setData("type", type); e.dataTransfer.setData("cost", cost); };
        
        window.drop = (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData("type"), cost = parseInt(e.dataTransfer.getData("cost"));
            const rect = document.getElementById('arena').getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            if (elixir >= cost && gameId && gameActive && y > 275) {
                elixir -= cost;
                push(ref(db, `games/${gameId}/moves`), { type, x, y, sender: myName, id: Math.random() });
            }
        };

        window.findMatch = async () => {
            myName = document.getElementById('nameInput').value || "Player";
            const qRef = ref(db, 'queue');
            const snap = await get(qRef);
            if (snap.exists()) {
                const enemy = Object.values(snap.val())[0];
                gameId = enemy.name + "_vs_" + myName;
                await remove(qRef);
                await set(ref(db, `games/${gameId}`), { p1: enemy.name, p2: myName, abandoned: false });
                onDisconnect(ref(db, `games/${gameId}`)).update({ abandoned: myName });
                start();
            } else {
                set(ref(db, 'queue/' + myName), { name: myName });
                onDisconnect(ref(db, 'queue/' + myName)).remove();
                onValue(ref(db, 'games'), (s) => { 
                    if (!gameId) for (let id in s.val()) if (id.includes(myName)) { gameId = id; start(); } 
                });
            }
        };

        function start() {
            gameActive = true;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            onValue(ref(db, `games/${gameId}`), (s) => { if (s.val()?.abandoned) location.reload(); });
            setInterval(() => { if (elixir < 10) elixir = Math.min(10, elixir + 0.1); updateUI(); }, 300);
            onChildAdded(ref(db, `games/${gameId}/moves`), (s) => spawn(s.val()));
            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            document.getElementById('elixir-fill').style.width = (elixir * 10) + '%';
            document.getElementById('elixir-text').innerText = Math.floor(elixir);
            for (let id in towers) { 
                const el = document.getElementById(id);
                if (el) el.innerText = Math.floor(towers[id]); 
            }
        }

        function spawn(m) {
            const isMine = m.sender === myName;
            const u = {
                id: m.id, type: m.type, x: isMine ? m.x : 350 - m.x, y: isMine ? m.y : 550 - m.y,
                hp: m.type === 'giant' ? 150 : 60, team: isMine ? 'blue' : 'red',
                el: document.createElement('div')
            };
            u.el.className = 'unit'; u.el.style.backgroundColor = isMine ? '#05c' : '#c03';
            document.getElementById('arena').appendChild(u.el);
            units.push(u);
        }

        function gameLoop() {
            if (!gameActive) return;
            units.forEach((u, idx) => {
                let target = null, minDist = 1000;
                
                // Target enemy units first
                units.forEach(enemy => {
                    if (enemy.team !== u.team) {
                        let d = Math.hypot(enemy.x - u.x, enemy.y - u.y);
                        if (d < minDist) { minDist = d; target = enemy; }
                    }
                });

                // If no units, target towers
                if (minDist > 100) {
                    const tList = u.team === 'blue' ? ['eL', 'eR', 'eKing'] : ['mL', 'mR', 'mKing'];
                    tList.forEach(tId => {
                        if (towers[tId] > 0) {
                            const tEl = document.getElementById(tId);
                            const tx = tEl.offsetLeft + 20, ty = tEl.offsetTop + 20;
                            let d = Math.hypot(tx - u.x, ty - u.y);
                            if (d < minDist) { minDist = d; target = {x: tx, y: ty, isTower: true, id: tId}; }
                        }
                    });
                }

                if (minDist < 30) {
                    if (target.isTower) towers[target.id] -= 0.1;
                    else target.hp -= 0.4;
                } else {
                    let angle = Math.atan2(target.y - u.y, target.x - u.x);
                    u.x += Math.cos(angle) * (u.type === 'giant' ? 0.6 : 1.1); // SLOWER SPEED
                    u.y += Math.sin(angle) * (u.type === 'giant' ? 0.6 : 1.1);
                }

                // TOWER ATTACKS UNITS (Percentage dmg)
                const myTowers = u.team === 'red' ? ['mKing', 'mL', 'mR'] : ['eKing', 'eL', 'eR'];
                myTowers.forEach(tId => {
                    if (towers[tId] > 0) {
                        const tEl = document.getElementById(tId);
                        const tx = tEl.offsetLeft + 20, ty = tEl.offsetTop + 20;
                        if (Math.hypot(tx - u.x, ty - u.y) < 100) u.hp -= 0.15; // Chip damage
                    }
                });

                u.el.style.left = (u.x - 12) + 'px'; u.el.style.top = (u.y - 12) + 'px';
                if (u.hp <= 0) { u.el.remove(); units.splice(idx, 1); }
            });

            if (towers.eKing <= 0 || towers.mKing <= 0) {
                gameActive = false;
                alert(towers.eKing <= 0 ? "3 CROWN VICTORY!" : "DEFEAT!");
                location.reload();
            } else {
                requestAnimationFrame(gameLoop);
            }
        }
    </script>
</body>
</html>
