<!DOCTYPE html>
<html>
<head>
    <title>Clash Web Pro - Fazbear Edition</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        #setup { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle, #333, #111); }
        #game-ui { display: none; }
        
        /* ARENA WITH IMAGE SUPPORT */
        #arena { 
            width: 320px; height: 480px; 
            background: #4e7d34;
            background-size: 100% 100%; background-position: center;
            margin: 10px auto; position: relative; border: 4px solid #fff; border-radius: 10px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden;
        }

        .tower { position: absolute; width: 60px; height: 60px; border: 3px solid #000; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; z-index: 5; background-color: rgba(0,0,0,0.3); color: white; }
        .name-label { position: absolute; width: 120px; top: -25px; left: -30px; font-weight: bold; color: #ffeb3b; text-shadow: 2px 2px #000; pointer-events: none; font-size: 14px; }
        
        /* UNITS */
        .unit { width: 40px; height: 40px; position: absolute; z-index: 10; font-size: 10px; font-weight: bold; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
        .unit img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5)); }
        .hp-bar { width: 100%; height: 5px; background: #444; border: 1px solid #000; margin-bottom: 2px; border-radius: 2px; overflow: hidden; }
        .hp-fill { height: 100%; background: #2ecc71; transition: width 0.1s; }

        #ui-bar { width: 320px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #222; border-radius: 10px 10px 0 0; }
        #elixir-container { width: 160px; height: 16px; background: #444; border: 2px solid #fff; border-radius: 8px; overflow: hidden; position: relative; }
        #elixir-fill { height: 100%; background: #9b59b6; width: 0%; transition: width 0.2s linear; }
        #timer { font-weight: bold; color: #f1c40f; font-size: 18px; }

        .hand { display: flex; justify-content: center; gap: 8px; padding: 10px; background: #222; border-top: 2px solid #444; }
        .card { width: 70px; height: 85px; background: #34495e; border: 2px solid #ecf0f1; cursor: grab; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; font-size: 11px; font-weight: bold; }
        .card img { width: 40px; height: 40px; margin-bottom: 5px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="setup">
        <h1 style="color: #f1c40f; margin: 0; font-size: 42px; text-shadow: 3px 3px #000;">FAZBEAR ROYALE</h1>
        <p style="opacity: 0.8; font-weight: bold;">Multiplayer Battle</p>
        <input type="text" id="nameInput" placeholder="Enter Nickname" maxlength="10" style="padding: 12px; margin: 15px; border-radius: 5px; border: none; font-size: 16px; width: 200px; text-align: center;">
        <button onclick="findMatch()" id="btn-text" style="padding: 15px 50px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 20px; box-shadow: 0 4px #1e8449;">BATTLE</button>
        <p id="status" style="margin-top: 20px;">Ready to play...</p>
    </div>

    <div id="game-ui">
        <div id="ui-bar">
            <div id="timer">01:00</div>
            <div id="elixir-container"><div id="elixir-fill"></div></div>
            <div id="elixir-text" style="color:#d0f; font-weight: bold; font-size: 20px;">5</div>
        </div>

        <div id="arena" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div id="eTower" class="tower" style="top: 25px; left: 130px; border-color: #c0392b;">
                <span id="enemyNameDisplay" class="name-label">Enemy</span>
                <span id="eHP" style="font-weight: bold; font-size: 18px;">2500</span>
            </div>
            <div id="myTower" class="tower" style="bottom: 25px; left: 130px; border-color: #2980b9;">
                <span id="myNameDisplay" class="name-label">Me</span>
                <span id="myHP" style="font-weight: bold; font-size: 18px;">2500</span>
            </div>
        </div>

        <div class="hand">
            <div class="card" draggable="true" ondragstart="drag(event, 'knight', 3)">
                <img src="https://www.clashroyale.com/uploaded-images/knight-icon.png"> Knight (3)
            </div>
            <div class="card" draggable="true" ondragstart="drag(event, 'giant', 5)">
                <img src="https://www.clashroyale.com/uploaded-images/giant-icon.png"> Giant (5)
            </div>
            <div class="card" draggable="true" ondragstart="drag(event, 'freddy', 4)">
                <img src="https://static.wikia.nocookie.net/fnaf-world-adventure/images/e/e3/Freddy_Fazbear_Icon.png"> Freddy (4)
            </div>
            <div class="card" draggable="true" ondragstart="drag(event, 'fazbear', 7)">
                <img src="https://static.wikia.nocookie.net/freddy-fazbears-pizzeria-simulator/images/f/f1/Lefty_Icon.png"> Afghan (7)
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, update, push, onValue, onChildAdded, remove, get, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // --- ðŸ–¼ï¸ IMAGE LINKS ---
        const IMAGES = {
            arena: "https://i.redd.it/39v8084shnba1.png", 
            knight: "https://vignette.wikia.nocookie.net/clashroyale/images/1/14/KnightCard.png",
            giant: "https://vignette.wikia.nocookie.net/clashroyale/images/6/6a/GiantCard.png",
            freddy: "https://images.wikidates.org/f/f6/Freddy_Fazbear_Icon.png",
            fazbear: "https://static.wikia.nocookie.net/fnaf-world-adventure/images/2/23/Golden_Freddy_Icon.png"
        };
        document.getElementById('arena').style.backgroundImage = `url('${IMAGES.arena}')`;

        const firebaseConfig = {
            apiKey: "AIzaSyAJGeR1gfk3l_0g4Fjeyu2RzhUdP94U1yM",
            authDomain: "clash-royale-3bd59.firebaseapp.com",
            projectId: "clash-royale-3bd59",
            databaseURL: "https://clash-royale-3bd59-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myName = "", enemyName = "", gameId = null, elixir = 5, eHP = 2500, mHP = 2500;
        let units = [], gameActive = false, elixirMult = 1, timeLeft = 60;

        window.allowDrop = (e) => e.preventDefault();
        window.drag = (e, type, cost) => { e.dataTransfer.setData("type", type); e.dataTransfer.setData("cost", cost); };
        
        window.drop = (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData("type"), cost = parseInt(e.dataTransfer.getData("cost"));
            const rect = document.getElementById('arena').getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            if (elixir >= cost && gameActive && y > 240) {
                elixir -= cost;
                push(ref(db, `games/${gameId}/moves`), { type, x, y, sender: myName, id: Math.random() });
            }
        };

        window.findMatch = async () => {
            myName = document.getElementById('nameInput').value.trim() || "P" + Math.floor(Math.random()*999);
            document.getElementById('status').innerText = "Searching for opponent...";
            const qRef = ref(db, 'queue');
            const snap = await get(qRef);

            if (snap.exists() && Object.values(snap.val())[0].name !== myName) {
                enemyName = Object.values(snap.val())[0].name;
                gameId = enemyName + "_vs_" + myName;
                await remove(qRef);
                await set(ref(db, `games/${gameId}`), { p1: enemyName, p2: myName, start: true });
                start();
            } else {
                set(ref(db, 'queue/' + myName), { name: myName });
                onValue(ref(db, 'games'), (s) => { 
                    if (!gameId) for (let id in s.val()) if (id.includes(myName) && s.val()[id].start) { gameId = id; start(); }
                });
            }
        };

        function start() {
            gameActive = true;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('myNameDisplay').innerText = myName;

            onValue(ref(db, `games/${gameId}`), (s) => {
                if(!s.exists()) return;
                enemyName = (s.val().p1 === myName) ? s.val().p2 : s.val().p1;
                document.getElementById('enemyNameDisplay').innerText = enemyName;
            });

            setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    document.getElementById('timer').innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                } else {
                    elixirMult = 2;
                    document.getElementById('timer').innerText = "2X!";
                }
            }, 1000);

            setInterval(() => { if (elixir < 10 && gameActive) elixir = Math.min(10, elixir + (0.08 * elixirMult)); updateUI(); }, 400);
            onChildAdded(ref(db, `games/${gameId}/moves`), (s) => spawn(s.val()));
            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            document.getElementById('elixir-fill').style.width = (elixir * 10) + '%';
            document.getElementById('elixir-text').innerText = Math.floor(elixir);
            document.getElementById('eHP').innerText = Math.floor(eHP);
            document.getElementById('myHP').innerText = Math.floor(mHP);
        }

        function spawn(m) {
            const isMine = m.sender === myName;
            const stats = {
                knight: { hp: 180, dmg: 1.5, speed: 0.8 },
                giant: { hp: 450, dmg: 2.2, speed: 0.5 },
                freddy: { hp: 550, dmg: 12, speed: 0.4 },
                fazbear: { hp: 1, dmg: 10000, speed: 4.8 }
            }[m.type];

            const u = {
                id: m.id, type: m.type, x: isMine ? m.x : 320 - m.x, y: isMine ? m.y : 480 - m.y,
                hp: stats.hp, maxHp: stats.hp, dmg: stats.dmg, speed: stats.speed,
                team: isMine ? 'blue' : 'red', el: document.createElement('div')
            };
            u.el.className = 'unit';
            u.el.innerHTML = `
                <div class="hp-bar"><div class="hp-fill" id="hp-${u.id}"></div></div>
                <img src="${IMAGES[m.type]}">
            `;
            document.getElementById('arena').appendChild(u.el);
            units.push(u);
        }

        function gameLoop() {
            if (!gameActive) return;
            units.forEach((u, idx) => {
                let target = null, minDist = 1000;

                units.forEach(enemy => {
                    if (enemy.team !== u.team) {
                        let d = Math.hypot(enemy.x - u.x, enemy.y - u.y);
                        if (d < minDist) { minDist = d; target = enemy; }
                    }
                });

                if (minDist > 85 || u.type === 'fazbear') {
                    let tx = 160, ty = (u.team === 'blue' ? 45 : 435);
                    let d = Math.hypot(tx - u.x, ty - u.y);
                    if (d < minDist) { minDist = d; target = {x: tx, y: ty, isTower: true}; }
                }

                if (minDist < (u.type === 'fazbear' ? 50 : 35)) {
                    if (target.isTower) {
                        if (u.team === 'blue') eHP -= u.dmg; else mHP -= u.dmg;
                        if (u.type === 'fazbear') u.hp = 0;
                    } else {
                        target.hp -= u.dmg;
                        document.getElementById(`hp-${target.id}`).style.width = (target.hp / target.maxHp * 100) + '%';
                        if (u.type === 'fazbear') u.hp = 0;
                    }
                } else if (target) {
                    let angle = Math.atan2(target.y - u.y, target.x - u.x);
                    u.x += Math.cos(angle) * u.speed;
                    u.y += Math.sin(angle) * u.speed;
                }

                u.el.style.left = (u.x - 20) + 'px'; u.el.style.top = (u.y - 20) + 'px';
                if (u.hp <= 0) { u.el.remove(); units.splice(idx, 1); }
            });

            if (eHP <= 0 || mHP <= 0) {
                gameActive = false; alert(eHP <= 0 ? "ðŸ‘‘ VICTORY!" : "ðŸ’€ DEFEAT!"); location.reload();
            } else {
                requestAnimationFrame(gameLoop);
            }
        }
    </script>
</body>
</html>
